@page "/ogretmen/ekle"
@page "/admin/ogretmen/ekle"
@using StudentManagementFrontend.Models
@using StudentManagementFrontend.Services
@using Microsoft.AspNetCore.Authorization
@inject ITeacherService TeacherService
@inject NavigationManager Navigation
@inject ILogger<AddTeacher> Logger

<PageTitle>Yeni Öğretmen Ekle</PageTitle>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="/ogretmenler">Öğretmenler</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Yeni Öğretmen</li>
                        </ol>
                    </nav>
                </div>
                
                <div class="card-body">
                    <h2 class="h4 mb-4">
                        <i class="bi bi-person-plus me-2"></i>Yeni Öğretmen Ekle
                    </h2>
                    
                    <TeacherForm 
                        Teacher="@Teacher" 
                        OnSubmit="HandleValidSubmit" 
                        OnCancel="Cancel"
                        OnSaveDraftCallback="SaveDraft"
                        IsEditMode="false" />
                </div>
            </div>
        </div>
    </div>
</div>

@if (ShowSuccessAlert)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Başarılı!</strong> Öğretmen başarıyla eklendi.
            <button type="button" class="btn-close" @onclick="() => ShowSuccessAlert = false" aria-label="Kapat"></button>
        </div>
    </div>
}

@if (ShowErrorAlert)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Hata!</strong> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ShowErrorAlert = false" aria-label="Kapat"></button>
        </div>
    </div>
}

@code {
    private Teacher Teacher { get; set; } = new()
    {
        IsActive = true,
        HireDate = DateTime.Today
    };
    
    private bool ShowSuccessAlert { get; set; }
    private bool ShowErrorAlert { get; set; }
    private string ErrorMessage { get; set; } = string.Empty;
    
    private async Task HandleValidSubmit(Teacher teacher)
    {
        try
        {
            // Check if a teacher with the same email already exists
            var existingTeacher = await TeacherService.GetTeacherByEmailAsync(teacher.Email);
            if (existingTeacher != null)
            {
                ErrorMessage = "Bu e-posta adresi ile kayıtlı bir öğretmen zaten mevcut.";
                ShowErrorAlert = true;
                return;
            }
            
            var createdTeacher = await TeacherService.CreateTeacherAsync(teacher);
            if (createdTeacher != null && createdTeacher.Id > 0)
            {
                // Reset the form
                Teacher = new Teacher { IsActive = true, HireDate = DateTime.Today };
                ShowSuccessAlert = true;
                
                // Optionally, navigate to the teacher detail page
                // Navigation.NavigateTo($"/ogretmen/{createdTeacher.Id}");
            }
            else
            {
                throw new Exception("Öğretmen oluşturulurken bir hata oluştu.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding teacher");
            ErrorMessage = "Öğretmen eklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.";
            ShowErrorAlert = true;
        }
    }
    
    private async Task SaveDraft(Teacher teacher)
    {
        try
        {
            // In a real app, you might save this to local storage or a draft section
            // For now, we'll just show a success message
            ShowSuccessAlert = true;
            await Task.Delay(1000); // Simulate async operation
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving teacher draft");
            ErrorMessage = "Taslak kaydedilirken bir hata oluştu.";
            ShowErrorAlert = true;
        }
    }
    
    private void Cancel()
    {
        Navigation.NavigateTo("/ogretmenler");
    }
}
