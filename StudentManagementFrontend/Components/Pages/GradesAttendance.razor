@page "/grades-attendance"
@page "/not-devamsizlik"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Notlar ve Devamsızlık - Öğrenci Otomasyon Sistemi</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">Notlar ve Devamsızlık</h1>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewOptions" id="gradesView" 
                           checked="@(currentView == "grades")" @onchange="() => SwitchView(\"grades\")" autocomplete="off">
                    <label class="btn btn-outline-primary" for="gradesView">Notlar</label>

                    <input type="radio" class="btn-check" name="viewOptions" id="attendanceView" 
                           checked="@(currentView == "attendance")" @onchange="() => SwitchView(\"attendance\")" autocomplete="off">
                    <label class="btn btn-outline-primary" for="attendanceView">Devamsızlık</label>

                    <input type="radio" class="btn-check" name="viewOptions" id="summaryView" 
                           checked="@(currentView == "summary")" @onchange="() => SwitchView(\"summary\")" autocomplete="off">
                    <label class="btn btn-outline-primary" for="summaryView">Özet</label>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    }
    else
    {
        @if (currentView == "grades")
        {
            <!-- Grades View -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                @if (isTeacher || isAdmin)
                                {
                                    <span>Öğrenci Notları - Not Girişi</span>
                                }
                                else
                                {
                                    <span>Notlarım</span>
                                }
                            </h6>
                            @if (isTeacher || isAdmin)
                            {
                                <button class="btn btn-primary btn-sm" @onclick="OpenGradeModal">
                                    <i class="fas fa-plus"></i> Not Gir
                                </button>
                            }
                        </div>
                        <div class="card-body">
                            @if (grades?.Any() == true)
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                @if (isTeacher || isAdmin)
                                                {
                                                    <th>Öğrenci</th>
                                                }
                                                <th>Ders Kodu</th>
                                                <th>Ders Adı</th>
                                                <th>Not</th>
                                                <th>Harf Notu</th>
                                                <th>Durum</th>
                                                <th>Yorum</th>
                                                @if (isTeacher || isAdmin)
                                                {
                                                    <th>İşlemler</th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var grade in grades)
                                            {
                                                <tr>
                                                    @if (isTeacher || isAdmin)
                                                    {
                                                        <td>@grade.StudentName</td>
                                                    }
                                                    <td>@grade.Code</td>
                                                    <td>@grade.Name</td>
                                                    <td>
                                                        @if (grade.Grade.HasValue)
                                                        {
                                                            <span class="badge bg-@GetGradeColor(grade.Grade.Value) fs-6">
                                                                @grade.Grade.Value
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">Henüz girilmedi</span>
                                                        }
                                                    </td>
                                                    <td>@GetLetterGrade(grade.Grade)</td>
                                                    <td>
                                                        @if (grade.Grade.HasValue)
                                                        {
                                                            <span class="badge bg-@(grade.Grade >= 50 ? "success" : "danger")">
                                                                @(grade.Grade >= 50 ? "Başarılı" : "Başarısız")
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Beklemede</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @(string.IsNullOrEmpty(grade.Comment) ? "-" : grade.Comment)
                                                    </td>
                                                    @if (isTeacher || isAdmin)
                                                    {
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                    @onclick="() => EditGrade(grade)">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </td>
                                                    }
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                @if (isStudent)
                                {
                                    <!-- Grade Statistics for Students -->
                                    <div class="row mt-4">
                                        <div class="col-md-3">
                                            <div class="card bg-primary text-white">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3">
                                                            <i class="fas fa-calculator fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            <div class="small">Genel Ortalama</div>
                                                            <div class="h4">@CalculateGPA().ToString("F2")</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-success text-white">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3">
                                                            <i class="fas fa-check-circle fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            <div class="small">Başarılı Ders</div>
                                                            <div class="h4">@grades.Count(g => g.Grade >= 50)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3">
                                                            <i class="fas fa-times-circle fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            <div class="small">Başarısız Ders</div>
                                                            <div class="h4">@grades.Count(g => g.Grade < 50)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-warning text-dark">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3">
                                                            <i class="fas fa-hourglass-half fa-2x"></i>
                                                        </div>
                                                        <div>
                                                            <div class="small">Bekleyen Not</div>
                                                            <div class="h4">@grades.Count(g => !g.Grade.HasValue)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">@(isStudent ? "Henüz notunuz bulunmamaktadır." : "Henüz not girilmemiştir.")</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (currentView == "attendance")
        {
            <!-- Attendance View -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                @if (isTeacher || isAdmin)
                                {
                                    <span>Devamsızlık Takibi</span>
                                }
                                else
                                {
                                    <span>Devamsızlık Durumum</span>
                                }
                            </h6>
                            @if (isTeacher || isAdmin)
                            {
                                <button class="btn btn-warning btn-sm" @onclick="OpenAttendanceModal">
                                    <i class="fas fa-calendar-check"></i> Devamsızlık İşle
                                </button>
                            }
                        </div>
                        <div class="card-body">
                            @if (attendanceRecords?.Any() == true)
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                @if (isTeacher || isAdmin)
                                                {
                                                    <th>Öğrenci</th>
                                                }
                                                <th>Ders</th>
                                                <th>Tarih</th>
                                                <th>Durum</th>
                                                <th>Saat</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var record in attendanceRecords.OrderByDescending(a => a.Date))
                                            {
                                                <tr>
                                                    @if (isTeacher || isAdmin)
                                                    {
                                                        <td>@record.StudentName</td>
                                                    }
                                                    <td>@record.Name</td>
                                                    <td>@record.Date.ToString("dd/MM/yyyy")</td>
                                                    <td>
                                                        <span class="badge bg-@(record.Present ? "success" : "danger")">
                                                            @(record.Present ? "Katıldı" : "Katılmadı")
                                                        </span>
                                                    </td>
                                                    <td>@record.Date.ToString("HH:mm")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">@(isStudent ? "Henüz devamsızlık kaydınız bulunmamaktadır." : "Henüz devamsızlık kaydı girilmemiştir.")</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (currentView == "summary")
        {
            <!-- Summary View -->
            <div class="row">
                <!-- Academic Performance Chart -->
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Akademik Performans Özeti</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="performanceChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">İstatistikler</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="small text-muted">Toplam Ders Sayısı</div>
                                <div class="h4 font-weight-bold">@(grades?.Count() ?? 0)</div>
                            </div>
                            <div class="mb-4">
                                <div class="small text-muted">Genel Not Ortalaması</div>
                                <div class="h4 font-weight-bold text-@(CalculateGPA() >= 70 ? "success" : CalculateGPA() >= 50 ? "warning" : "danger")">
                                    @CalculateGPA().ToString("F2")
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="small text-muted">Başarı Oranı</div>
                                <div class="h4 font-weight-bold text-success">
                                    @if (grades?.Any() == true)
                                    {
                                        @Math.Round((double)grades.Count(g => g.Grade >= 50) / grades.Count() * 100, 1)%
                                    }
                                    else
                                    {
                                        <span>0%</span>
                                    }
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="small text-muted">Devamsızlık Oranı</div>
                                <div class="h4 font-weight-bold text-warning">
                                    @if (attendanceRecords?.Any() == true)
                                    {
                                        @Math.Round((double)attendanceRecords.Count(a => !a.Present) / attendanceRecords.Count() * 100, 1)%
                                    }
                                    else
                                    {
                                        <span>0%</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private ClaimsPrincipal? currentUser;
    private bool isLoading = true;
    private bool isAdmin = false;
    private bool isTeacher = false;
    private bool isStudent = false;
    private string currentView = "grades";

    private IEnumerable<dynamic>? grades;
    private IEnumerable<dynamic>? attendanceRecords;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = authState.User;

        if (currentUser.Identity?.IsAuthenticated == true)
        {
            isAdmin = currentUser.IsInRole("Admin");
            isTeacher = currentUser.IsInRole("Teacher");
            isStudent = currentUser.IsInRole("Student");

            await LoadData();
        }

        isLoading = false;
    }

    private async Task LoadData()
    {
        try
        {
            await LoadGrades();
            await LoadAttendance();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading grades/attendance data: {ex.Message}");
        }
    }

    private async Task LoadGrades()
    {
        if (isStudent)
        {
            // Get current student's grades
            var studentsResponse = await Http.GetAsync("/api/student");
            if (studentsResponse.IsSuccessStatusCode)
            {
                var students = await studentsResponse.Content.ReadFromJsonAsync<IEnumerable<dynamic>>();
                var currentStudent = students?.FirstOrDefault(s => 
                    s.GetProperty("email").GetString() == currentUser?.Identity?.Name);

                if (currentStudent != null)
                {
                    var studentId = currentStudent.GetProperty("id").GetInt32();
                    var gradesResponse = await Http.GetAsync($"/api/grade/by-student/{studentId}");
                    if (gradesResponse.IsSuccessStatusCode)
                    {
                        grades = await gradesResponse.Content.ReadFromJsonAsync<IEnumerable<dynamic>>();
                    }
                }
            }
        }
        else if (isTeacher || isAdmin)
        {
            // Load all grades for teachers/admins
            // This would need additional API endpoints to get all grades
            // For now, we'll simulate with sample data
        }
    }

    private async Task LoadAttendance()
    {
        if (isStudent)
        {
            // Get current student's attendance
            var studentsResponse = await Http.GetAsync("/api/student");
            if (studentsResponse.IsSuccessStatusCode)
            {
                var students = await studentsResponse.Content.ReadFromJsonAsync<IEnumerable<dynamic>>();
                var currentStudent = students?.FirstOrDefault(s => 
                    s.GetProperty("email").GetString() == currentUser?.Identity?.Name);

                if (currentStudent != null)
                {
                    var studentId = currentStudent.GetProperty("id").GetInt32();
                    var attendanceResponse = await Http.GetAsync($"/api/attendance/by-student/{studentId}");
                    if (attendanceResponse.IsSuccessStatusCode)
                    {
                        attendanceRecords = await attendanceResponse.Content.ReadFromJsonAsync<IEnumerable<dynamic>>();
                    }
                }
            }
        }
        else if (isTeacher || isAdmin)
        {
            // Load all attendance records for teachers/admins
        }
    }

    private void SwitchView(string view)
    {
        currentView = view;
        StateHasChanged();
    }

    private string GetGradeColor(double grade)
    {
        if (grade >= 90) return "success";
        if (grade >= 80) return "info";
        if (grade >= 70) return "primary";
        if (grade >= 60) return "warning";
        if (grade >= 50) return "secondary";
        return "danger";
    }

    private string GetLetterGrade(double? grade)
    {
        if (!grade.HasValue) return "-";
        
        if (grade >= 90) return "AA";
        if (grade >= 85) return "BA";
        if (grade >= 80) return "BB";
        if (grade >= 75) return "CB";
        if (grade >= 70) return "CC";
        if (grade >= 65) return "DC";
        if (grade >= 60) return "DD";
        if (grade >= 50) return "FD";
        return "FF";
    }

    private double CalculateGPA()
    {
        if (grades?.Any() != true)
            return 0;

        var gradesWithValues = grades.Where(g => g.Grade.HasValue).ToList();
        if (!gradesWithValues.Any())
            return 0;

        return gradesWithValues.Average(g => (double)g.Grade.Value);
    }

    private void OpenGradeModal()
    {
        // Implementation for opening grade input modal
    }

    private void EditGrade(dynamic grade)
    {
        // Implementation for editing grade
    }

    private void OpenAttendanceModal()
    {
        // Implementation for opening attendance modal
    }
}