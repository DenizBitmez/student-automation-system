@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using StudentManagementFrontend.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject StudentService StudentService
@inject HttpClient Http
@attribute [Authorize]


<PageTitle>Dashboard - Öğrenci Otomasyon Sistemi</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                <div class="text-muted">
                    Hoş geldiniz, @currentUser?.Identity?.Name
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    }
    else
    {
        <AuthorizeView Roles="Admin,Teacher">
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Toplam Öğrenci
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@totalStudents</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-user-graduate fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Toplam Öğretmen
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@totalTeachers</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Toplam Ders
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@totalCourses</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Toplam Kayıt
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@totalEnrollments</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <AuthorizeView Roles="Admin" Context="adminContext">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Hızlı İşlemler</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <a href="/add-student" class="list-group-item list-group-item-action">
                                        <i class="fas fa-plus-circle text-success me-2"></i>
                                        Yeni Öğrenci Ekle
                                    </a>
                                    <a href="/add-teacher" class="list-group-item list-group-item-action">
                                        <i class="fas fa-plus-circle text-info me-2"></i>
                                        Yeni Öğretmen Ekle
                                    </a>
                                    <a href="/add-course" class="list-group-item list-group-item-action">
                                        <i class="fas fa-plus-circle text-warning me-2"></i>
                                        Yeni Ders Ekle
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>
        </AuthorizeView>

        <AuthorizeView Roles="Student">
            <div class="row">
                 <div class="col-md-12 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                         <div class="card-body">
                            <h4 class="card-title text-primary">Öğrenci Paneli</h4>
                             <p class="card-text">
                                 Merhaba! Sol menüden derslerinize ve notlarınıza ulaşabilirsiniz.
                             </p>
                             <a href="/ogrenci/derslerim" class="btn btn-primary">
                                 <i class="bi bi-journal-text me-2"></i> Derslerime Git
                             </a>
                         </div>
                    </div>
                </div>
            </div>
        </AuthorizeView>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Sistem Bilgileri</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Öğrenci Otomasyon Sistemi v1.0</p>
                        <p class="text-muted">Son güncelleme: @DateTime.Now.ToString("dd/MM/yyyy")</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private ClaimsPrincipal? currentUser;
    private bool isLoading = true;
    private int totalStudents = 0;
    private int totalTeachers = 0;
    private int totalCourses = 0;
    private int totalEnrollments = 0;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
             var authState = await AuthenticationStateTask;
             currentUser = authState.User;
             
             if (currentUser.Identity?.IsAuthenticated == true)
             {
                 if (currentUser.IsInRole("Admin") || currentUser.IsInRole("Teacher"))
                 {
                     await LoadDashboardData();
                 }
             }
        }
        else
        {
            // Fallback if cascading parameter is not provided (though it should be)
             var authState = await AuthStateProvider.GetAuthenticationStateAsync();
             currentUser = authState.User;
             if (currentUser.Identity?.IsAuthenticated == true)
             {
                 if (currentUser.IsInRole("Admin") || currentUser.IsInRole("Teacher"))
                 {
                     await LoadDashboardData();
                 }
             }
        }

        isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load basic statistics
            var students = await StudentService.GetAllStudentsAsync();
            totalStudents = students.Count();
            
            // For now, set dummy values for other statistics
            totalTeachers = 10;
            totalCourses = 25;
            totalEnrollments = 150;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard data loading error: {ex.Message}");
        }
    }
}