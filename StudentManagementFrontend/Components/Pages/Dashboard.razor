@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using StudentManagementFrontend.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject StudentService StudentService
@inject HttpClient Http
@attribute [Authorize]


<PageTitle>Dashboard - Öğrenci Otomasyon Sistemi</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h1 class="h3 mb-1 fw-bold">Kontrol Paneli</h1>
                    <p class="text-muted mb-0">Hoş geldiniz, <span class="text-primary fw-medium">@currentUser?.Identity?.Name</span></p>
                </div>
                <div class="date-badge bg-white shadow-sm p-2 rounded-pill px-4 text-muted border">
                   <i class="bi bi-calendar3 me-2"></i> @DateTime.Now.ToString("dd MMMM yyyy")
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    }
    else
    {
        <AuthorizeView Roles="Admin,Teacher">
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 border-start border-4 border-primary hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-uppercase small fw-bold text-primary mb-1">Toplam Öğrenci</div>
                                    <div class="h3 mb-0 fw-bold text-dark">@totalStudents</div>
                                </div>
                                <div class="icon-circle bg-primary-subtle text-primary rounded-circle p-3">
                                    <i class="bi bi-people-fill fs-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 border-start border-4 border-success hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-uppercase small fw-bold text-success mb-1">Toplam Öğretmen</div>
                                    <div class="h3 mb-0 fw-bold text-dark">@totalTeachers</div>
                                </div>
                                <div class="icon-circle bg-success-subtle text-success rounded-circle p-3">
                                    <i class="bi bi-person-video3 fs-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 border-start border-4 border-info hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-uppercase small fw-bold text-info mb-1">Toplam Ders</div>
                                    <div class="h3 mb-0 fw-bold text-dark">@totalCourses</div>
                                </div>
                                <div class="icon-circle bg-info-subtle text-info rounded-circle p-3">
                                    <i class="bi bi-journal-bookmark-fill fs-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 border-start border-4 border-warning hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-uppercase small fw-bold text-warning mb-1">Toplam Kayıt</div>
                                    <div class="h3 mb-0 fw-bold text-dark">@totalEnrollments</div>
                                </div>
                                <div class="icon-circle bg-warning-subtle text-warning rounded-circle p-3">
                                    <i class="bi bi-clipboard-check-fill fs-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <AuthorizeView Roles="Admin" Context="adminContext">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-transparent border-bottom py-3">
                                <h6 class="m-0 fw-bold text-primary"><i class="bi bi-lightning-charge-fill me-2"></i>Hızlı İşlemler</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <a href="/ogrenci/ekle" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4">
                                        <div class="bg-success-subtle text-success rounded-circle p-2 me-3">
                                            <i class="bi bi-person-plus-fill"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Yeni Öğrenci Ekle</h6>
                                            <small class="text-muted">Sisteme yeni bir öğrenci kaydı oluştur</small>
                                        </div>
                                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                                    </a>
                                    <a href="/ogretmen/ekle" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4">
                                        <div class="bg-info-subtle text-info rounded-circle p-2 me-3">
                                            <i class="bi bi-person-badge-fill"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Yeni Öğretmen Ekle</h6>
                                            <small class="text-muted">Akademik kadroya yeni eğitmen ekle</small>
                                        </div>
                                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                                    </a>
                                    <a href="/ders/ekle" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4">
                                        <div class="bg-warning-subtle text-warning rounded-circle p-2 me-3">
                                            <i class="bi bi-journal-plus"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Yeni Ders Ekle</h6>
                                            <small class="text-muted">Müfredata yeni bir ders tanımla</small>
                                        </div>
                                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

            <AuthorizeView Roles="Teacher" Context="teacherContext">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-transparent border-bottom py-3">
                                <h6 class="m-0 fw-bold text-primary"><i class="bi bi-lightning-charge-fill me-2"></i>Hızlı İşlemler</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <a href="/dersler" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4">
                                        <div class="bg-primary-subtle text-primary rounded-circle p-2 me-3">
                                            <i class="bi bi-journal-check"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Not ve Yoklama Yönetimi</h6>
                                            <small class="text-muted">Derslerinize not girin veya yoklama alın</small>
                                        </div>
                                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                                    </a>
                                     <a href="/ogrenciler" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4">
                                        <div class="bg-info-subtle text-info rounded-circle p-2 me-3">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Öğrenci Listesi</h6>
                                            <small class="text-muted">Öğrencilerinizi görüntüleyin</small>
                                        </div>
                                        <i class="bi bi-chevron-right ms-auto text-muted"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>
        </AuthorizeView>

        <AuthorizeView Roles="Student">
            <div class="row">
                 <div class="col-md-12 mb-4">
                    <div class="card border-0 shadow-sm overflow-hidden h-100">
                         <div class="card-body p-5 text-center bg-primary-subtle position-relative">
                             <div class="position-relative z-1">
                                <h2 class="display-5 fw-bold text-primary mb-3">Öğrenci Paneli</h2>
                                <p class="lead mb-4 mx-auto" style="max-width: 600px;">
                                    Derslerinizi, notlarınızı ve devamsızlık durumunuzu buradan takip edebilirsiniz.
                                </p>
                                <a href="/ogrenci/derslerim" class="btn btn-primary btn-lg shadow-sm hover-scale">
                                    <i class="bi bi-journal-text me-2"></i> Derslerime Git
                                </a>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </AuthorizeView>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="d-flex justify-content-center mt-4">
                     <small class="text-muted">Öğrenci Otomasyon Sistemi v1.0 &copy; @DateTime.Now.Year</small>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .hover-lift {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
</style>

@code {
    private ClaimsPrincipal? currentUser;
    private bool isLoading = true;
    private int totalStudents = 0;
    private int totalTeachers = 0;
    private int totalCourses = 0;
    private int totalEnrollments = 0;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isLoading = true;
            StateHasChanged();

            if (AuthenticationStateTask != null)
            {
                 var authState = await AuthenticationStateTask;
                 currentUser = authState.User;
                 
                 if (currentUser.Identity?.IsAuthenticated == true)
                 {
                     if (currentUser.IsInRole("Admin") || currentUser.IsInRole("Teacher"))
                     {
                         await LoadDashboardData();
                     }
                 }
            }
            // Logic for non-cascading fallback omitted as cascading is standard
            
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load basic statistics
            var students = await StudentService.GetAllStudentsAsync();
            totalStudents = students.Count();
            
            // For now, set dummy values for other statistics
            totalTeachers = 10;
            totalCourses = 25;
            totalEnrollments = 150;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard data loading error: {ex.Message}");
        }
    }
}