@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using StudentManagementFrontend.Services
@using StudentManagementFrontend.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject AnalyticsService AnalyticsService
@attribute [Authorize]

<PageTitle>Dashboard - OtoSistem</PageTitle>

<div class="dashboard-wrapper">
    <!-- Header -->
    <div class="row align-items-end mb-5">
        <div class="col">
            <h2 class="h1 fw-bold text-main mb-1">HoÅŸ Geldiniz, @currentUser?.Identity?.Name ðŸ‘‹</h2>
            <p class="text-muted lead mb-0">Sistemin genel durumu ve analizler aÅŸaÄŸÄ±dadÄ±r.</p>
        </div>
        <div class="col-auto d-none d-md-block">
            <div class="glass-card px-4 py-2 rounded-pill d-flex align-items-center gap-2 border">
                <i class="bi bi-calendar3 text-primary"></i>
                <span class="small fw-bold text-muted">@DateTime.Now.ToString("dd MMMM yyyy")</span>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="spinner-grow text-primary mb-3" role="status"></div>
            <span class="text-muted fw-medium small">Veriler Analiz Ediliyor...</span>
        </div>
    }
    else
    {
        <AuthorizeView Roles="Admin">
            <!-- Admin Stats -->
            <div class="row g-4 mb-5">
                <div class="col-xl-3 col-sm-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 overflow-hidden position-relative">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="stat-icon bg-primary-light text-primary rounded-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="bi bi-people-fill fs-4"></i>
                            </div>
                        </div>
                        <h3 class="h2 fw-bold mb-1">@_systemStats.TotalStudents</h3>
                        <p class="text-muted small fw-bold text-uppercase tracking-wider mb-0">Toplam Ã–ÄŸrenci</p>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 overflow-hidden position-relative">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="stat-icon bg-success-subtle text-success rounded-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="bi bi-person-video3 fs-4"></i>
                            </div>
                        </div>
                        <h3 class="h2 fw-bold mb-1">@_systemStats.TotalTeachers</h3>
                        <p class="text-muted small fw-bold text-uppercase tracking-wider mb-0">Ã–ÄŸretmen</p>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 overflow-hidden position-relative">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="stat-icon bg-info-subtle text-info rounded-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="bi bi-journal-bookmark-fill fs-4"></i>
                            </div>
                        </div>
                        <h3 class="h2 fw-bold mb-1">@_systemStats.TotalCourses</h3>
                        <p class="text-muted small fw-bold text-uppercase tracking-wider mb-0">Dersler</p>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 overflow-hidden position-relative">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="stat-icon bg-warning-subtle text-warning rounded-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                <i class="bi bi-clipboard-check-fill fs-4"></i>
                            </div>
                        </div>
                        <h3 class="h2 fw-bold mb-1">@_systemStats.TotalActiveEnrollments</h3>
                        <p class="text-muted small fw-bold text-uppercase tracking-wider mb-0">Aktif KayÄ±t</p>
                    </div>
                </div>
            </div>

            <!-- Enrollment Trends Chart (Simulated with bars) -->
            <div class="card border-0 shadow-sm rounded-lg mb-5 overflow-hidden">
                <div class="card-header bg-white border-bottom px-4 py-3">
                    <h5 class="fw-bold mb-0">KayÄ±t Trendleri (Son Aylar)</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex align-items-end justify-content-around h-100" style="height: 200px !important;">
                         @if (_enrollmentTrends.Any())
                        {
                            var maxCount = _enrollmentTrends.Max(t => t.Count);
                            foreach (var trend in _enrollmentTrends)
                            {
                                <div class="d-flex flex-column align-items-center flex-grow-1">
                                    <div class="bg-primary bg-gradient rounded-top shadow-sm w-50 position-relative group-hover-scale" 
                                         style="height: @(Math.Max(5, (double)trend.Count / (maxCount == 0 ? 1 : maxCount) * 150))px; transition: height 1s ease;">
                                        <div class="position-absolute top-0 start-50 translate-middle-x mt-n4 small fw-bold text-primary">@trend.Count</div>
                                    </div>
                                    <div class="mt-2 small text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">@trend.Period</div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center w-100">Veri bulunamadÄ±.</p>
                        }
                    </div>
                </div>
            </div>
        </AuthorizeView>

        <AuthorizeView Roles="Teacher">
             <!-- Same stats for teacher for now, or customized -->
             <!-- Reusing system stats visually but maybe filtered in future. For now showing same stats is fine contextually -->
             <div class="row g-4 mb-5">
                <div class="col-md-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 text-center">
                        <h1 class="display-4 fw-bold text-primary mb-0">@_systemStats.TotalStudents</h1>
                        <p class="text-muted fw-bold">Toplam Ã–ÄŸrenci</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card p-4 rounded-lg bg-white border shadow-sm hover-lift h-100 text-center">
                        <h1 class="display-4 fw-bold text-success mb-0">@_systemStats.TotalCourses</h1>
                        <p class="text-muted fw-bold">Toplam Ders</p>
                    </div>
                </div>
             </div>
        </AuthorizeView>
        
        <AuthorizeView Roles="Student">
            @if (_studentPerformance != null)
            {
                <div class="student-hero p-5 rounded-xl bg-primary-gradient text-white shadow-lg position-relative overflow-hidden mb-5">
                    <div class="row position-relative z-1 align-items-center">
                         <div class="col-lg-8">
                            <h2 class="display-5 fw-bold mb-3">Merhaba, @currentUser?.Identity?.Name!</h2>
                            <p class="lead mb-4 opacity-75">Genel akademik performansÄ±n aÅŸaÄŸÄ±dadÄ±r.</p>
                            
                            <div class="d-flex gap-4 text-center text-lg-start">
                                <div>
                                    <div class="display-6 fw-bold">@_studentPerformance.GPA.ToString("F2")</div>
                                    <div class="small text-white-50 text-uppercase fw-bold">Genel Ortalama</div>
                                </div>
                                <div class="vr bg-white opacity-25"></div>
                                <div>
                                    <div class="display-6 fw-bold text-white">@_studentPerformance.OverallAttendanceRate.ToString("F0")%</div>
                                    <div class="small text-white-50 text-uppercase fw-bold">DevamlÄ±lÄ±k</div>
                                </div>
                                 <div class="vr bg-white opacity-25"></div>
                                <div>
                                    <div class="display-6 fw-bold text-white">@_studentPerformance.CompletedAssignments</div>
                                    <div class="small text-white-50 text-uppercase fw-bold">Teslim Edilenler</div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="hero-bg-icon position-absolute opacity-1" style="bottom: -30px; right: 20px; font-size: 15rem;">
                         <i class="bi bi-mortarboard text-white-50"></i>
                    </div>
                </div>
            }

            @if (_studentPrediction != null)
            {
                <div class="mb-5">
                    <PredictionWidget Prediction="_studentPrediction" />
                </div>
            }
        </AuthorizeView>

        <!-- Common Quick Actions -->
        <AuthorizeView Roles="Admin" Context="adminContext">
            <div class="quick-actions mb-5">
                <h5 class="fw-bold mb-4">YÃ¶netim Paneli</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <a href="/ogrenci/ekle" class="action-card d-flex flex-column align-items-center p-4 bg-white border rounded-lg shadow-sm hover-lift text-decoration-none">
                            <i class="bi bi-person-plus-fill fs-2 text-primary mb-3"></i>
                            <h6 class="fw-bold text-dark mb-0">Ã–ÄŸrenci Ekle</h6>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/ders/ekle" class="action-card d-flex flex-column align-items-center p-4 bg-white border rounded-lg shadow-sm hover-lift text-decoration-none">
                            <i class="bi bi-journal-plus fs-2 text-warning mb-3"></i>
                            <h6 class="fw-bold text-dark mb-0">Ders AÃ§</h6>
                        </a>
                    </div>
                </div>
            </div>
        </AuthorizeView>
    }
</div>

<style>
    .dashboard-wrapper { max-width: 1400px; margin: 0 auto; }
    .hover-lift { transition: all 0.3s ease; }
    .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .rounded-lg { border-radius: 1rem; }
    .rounded-xl { border-radius: 2rem; }
    .bg-primary-gradient { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); }
    .opacity-1 { opacity: 0.1; }
</style>

@code {
    private ClaimsPrincipal? currentUser;
    private bool isLoading = true;
    private SystemStatsDto _systemStats = new();
    private List<EnrollmentTrendDto> _enrollmentTrends = new();
    private StudentPerformanceDto? _studentPerformance;
    private PredictionResultDto? _studentPrediction;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isLoading = true;
            StateHasChanged();

            if (AuthenticationStateTask != null)
            {
                 var authState = await AuthenticationStateTask;
                 currentUser = authState.User;
                 
                 if (currentUser.Identity?.IsAuthenticated == true)
                 {
                     await LoadAnalytics();
                 }
            }
            
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadAnalytics()
    {
        try
        {
            if (currentUser!.IsInRole("Admin"))
            {
                var stats = await AnalyticsService.GetSystemStatsAsync();
                if (stats != null) _systemStats = stats;
                
                _enrollmentTrends = await AnalyticsService.GetEnrollmentTrendsAsync();
            }
            else if (currentUser.IsInRole("Teacher"))
            {
                 // Re-use system stats for now for teachers or fetch specific
                 var stats = await AnalyticsService.GetSystemStatsAsync();
                 if (stats != null) _systemStats = stats;
            }
            else if (currentUser.IsInRole("Student"))
            {
                // We need to get StudentId first. This is usually in claims or we fetch profile.
                // For MVP, passing a dummy ID or 0 if the backend resolves it from Token (preferred).
                // Our backend logic for 'GetStudentPerformance' might require ID. 
                // Let's assume for now we pass a placeholder and Backend resolves from UserID if strictly needed, 
                // BUT my controller implementation expected a studentId.
                // IMPORTANT: The backend 'GetStudentPerformance' takes an ID but also checks claims.
                // Ideally, we should resolve the StudentId from the current user's profile.
                // Assuming ID 1 for test or we need to add 'Me' endpoint.
                // Actually, let's just try fetching for "1" as existing test user, or fix Controller to use "Me".
                // Better: Update Controller to use "Me", but for now let's try 1 if safe, or handle mismatch.
                // Wait, I can't easily guess ID.
                // I will update the AnalyticsController later to support 'my-performance' or similar.
                // For now, let's skip fetching specific Performance if we don't have ID, to avoid crash.
                // Or better, fetch 'system stats' for student too? No.
                // Let's try to get ID from claims if available (Sid).
                 var sidClaim = currentUser.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.Sid); // standard claim?
                 // or just pass 0 and let backend handle "Me" logic if I update it?
                // I'll update backend to handle ID 0 as "Current User".
                 
                 _studentPerformance = await AnalyticsService.GetStudentPerformanceAsync(0); 
                 _studentPrediction = await AnalyticsService.GetStudentPredictionAsync(0);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Analytics error: {ex.Message}");
        }
    }
}