@page "/reset-password"
@page "/sifre-sifirla"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Şifre Sıfırla</PageTitle>

<div class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow" style="width: 100%; max-width: 400px;">
        <div class="card-header bg-success text-white text-center py-3">
            <h4 class="mb-0">Yeni Şifre Belirle</h4>
            <div class="small">Güçlü bir şifre seçin</div>
        </div>
        
        <div class="card-body p-4">
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert alert-@(isSuccess ? "success" : "danger")" role="alert">
                    <i class="bi bi-@(isSuccess ? "check-circle" : "exclamation-triangle") me-2"></i>
                    @message
                </div>
            }

            @if (!tokenValid)
            {
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Geçersiz veya Süresi Dolmuş Link</h5>
                    <p class="text-muted">Bu şifre sıfırlama linki geçersiz veya süresi dolmuş.</p>
                    <a href="/forgot-password" class="btn btn-warning">
                        <i class="bi bi-arrow-left me-2"></i>
                        Yeni Link Talep Et
                    </a>
                </div>
            }
            else if (isSuccess)
            {
                <div class="text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Şifre Başarıyla Sıfırlandı</h5>
                    <p class="text-muted">Artık yeni şifrenizle giriş yapabilirsiniz.</p>
                    <a href="/login" class="btn btn-success">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        Giriş Yap
                    </a>
                </div>
            }
            else
            {
                <EditForm Model="model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Yeni Şifre</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-lock"></i>
                            </span>
                            <InputText @bind-Value="model.NewPassword" type="@(showPassword ? "text" : "password")" 
                                       class="form-control" id="newPassword" placeholder="En az 6 karakter" disabled="@isLoading" />
                            <button type="button" class="btn btn-outline-secondary" @onclick="TogglePasswordVisibility">
                                <i class="bi bi-@(showPassword ? "eye-slash" : "eye")"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => model.NewPassword)" class="text-danger" />
                        
                        <!-- Password strength indicator -->
                        <div class="mt-2">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-@GetPasswordStrengthColor()" 
                                     style="width: @GetPasswordStrengthPercentage()%"></div>
                            </div>
                            <small class="text-muted">Şifre gücü: @GetPasswordStrengthText()</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Şifre Tekrarı</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-lock-fill"></i>
                            </span>
                            <InputText @bind-Value="model.ConfirmPassword" type="@(showConfirmPassword ? "text" : "password")" 
                                       class="form-control" id="confirmPassword" placeholder="Şifreyi tekrar girin" disabled="@isLoading" />
                            <button type="button" class="btn btn-outline-secondary" @onclick="ToggleConfirmPasswordVisibility">
                                <i class="bi bi-@(showConfirmPassword ? "eye-slash" : "eye")"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => model.ConfirmPassword)" class="text-danger" />
                    </div>

                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-success" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-check-lg me-2"></i>
                            Şifreyi Sıfırla
                        </button>
                    </div>
                </EditForm>

                <div class="text-center">
                    <a href="/login" class="btn btn-link btn-sm">
                        <i class="bi bi-arrow-left me-2"></i>
                        Giriş Sayfasına Dön
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter, SupplyParameterFromQuery]
    public string? Token { get; set; }

    private ResetPasswordModel model = new();
    private bool isLoading = false;
    private bool tokenValid = false;
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private string message = string.Empty;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            tokenValid = false;
            return;
        }

        // Verify token
        try
        {
            var response = await Http.PostAsync($"/api/passwordreset/verify-token?token={Token}", null);
            tokenValid = response.IsSuccessStatusCode;
            
            if (tokenValid)
            {
                var result = await response.Content.ReadFromJsonAsync<TokenVerificationResult>();
                // Could display email or expiration time here if needed
            }
        }
        catch
        {
            tokenValid = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (model.NewPassword != model.ConfirmPassword)
        {
            message = "Şifreler eşleşmiyor.";
            isSuccess = false;
            return;
        }

        isLoading = true;
        message = string.Empty;
        
        try
        {
            var response = await Http.PostAsJsonAsync("/api/passwordreset/reset-password", new 
            { 
                token = Token, 
                newPassword = model.NewPassword 
            });
            
            if (response.IsSuccessStatusCode)
            {
                isSuccess = true;
                message = "Şifreniz başarıyla sıfırlandı.";
            }
            else
            {
                var errorResponse = await response.Content.ReadAsStringAsync();
                isSuccess = false;
                message = "Şifre sıfırlanırken bir hata oluştu.";
            }
        }
        catch (Exception)
        {
            isSuccess = false;
            message = "Bağlantı hatası. Lütfen tekrar deneyin.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private int GetPasswordStrength()
    {
        if (string.IsNullOrEmpty(model.NewPassword)) return 0;
        
        int strength = 0;
        if (model.NewPassword.Length >= 6) strength += 20;
        if (model.NewPassword.Length >= 10) strength += 20;
        if (model.NewPassword.Any(char.IsLower)) strength += 10;
        if (model.NewPassword.Any(char.IsUpper)) strength += 10;
        if (model.NewPassword.Any(char.IsDigit)) strength += 20;
        if (model.NewPassword.Any(c => !char.IsLetterOrDigit(c))) strength += 20;
        
        return Math.Min(strength, 100);
    }

    private string GetPasswordStrengthPercentage()
    {
        return GetPasswordStrength().ToString();
    }

    private string GetPasswordStrengthColor()
    {
        var strength = GetPasswordStrength();
        return strength switch
        {
            <= 20 => "danger",
            <= 40 => "warning",
            <= 60 => "info",
            <= 80 => "primary",
            _ => "success"
        };
    }

    private string GetPasswordStrengthText()
    {
        var strength = GetPasswordStrength();
        return strength switch
        {
            <= 20 => "Çok Zayıf",
            <= 40 => "Zayıf",
            <= 60 => "Orta",
            <= 80 => "İyi",
            _ => "Çok Güçlü"
        };
    }

    public class ResetPasswordModel
    {
        [Required(ErrorMessage = "Yeni şifre zorunludur.")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Şifre en az 6 karakter olmalıdır.")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Şifre tekrarı zorunludur.")]
        [Compare("NewPassword", ErrorMessage = "Şifreler eşleşmiyor.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class TokenVerificationResult
    {
        public bool Valid { get; set; }
        public string Email { get; set; } = string.Empty;
        public DateTime ExpiresAt { get; set; }
    }
}