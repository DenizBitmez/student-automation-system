@page "/ogretmen/{TeacherId:int}"
@page "/admin/ogretmen/{TeacherId:int}"
@using StudentManagementFrontend.Models
@using StudentManagementFrontend.Services
@using Microsoft.AspNetCore.Authorization
@inject ITeacherService TeacherService
@inject NavigationManager Navigation
@inject ILogger<TeacherDetail> Logger

<PageTitle>Öğretmen Detayı</PageTitle>

@if (IsLoading)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
    </div>
}
else if (Teacher == null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Öğretmen bulunamadı veya yüklenirken bir hata oluştu.
    </div>
    
    <div class="mt-3">
        <button class="btn btn-outline-secondary" @onclick="() => Navigation.NavigateTo("/ogretmenler")">
            <i class="bi bi-arrow-left me-2"></i>Öğretmen Listesine Dön
        </button>
    </div>
}
else
{
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            @if (!string.IsNullOrEmpty(Teacher.ProfileImageUrl))
                            {
                                <img src="@Teacher.ProfileImageUrl" alt="@Teacher.FullName" class="img-fluid rounded-circle" style="width: 150px; height: 150px; object-fit: cover;" />
                            }
                            else
                            {
                                <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle" style="width: 150px; height: 150px; font-size: 48px;">
                                    @Teacher.FirstName[0]@(Teacher.LastName?.Length > 0 ? Teacher.LastName[0].ToString() : "")
                                </div>
                            }
                        </div>
                        
                        <h3 class="h4">@Teacher.FullName</h3>
                        
                        <div class="mt-3">
                            <span class="badge @(Teacher.IsActive ? "bg-success" : "bg-secondary") fs-6">
                                @(Teacher.IsActive ? "Aktif" : "Pasif")
                            </span>
                        </div>
                        
                        <div class="mt-4 text-start">
                            <div class="mb-2">
                                <i class="bi bi-envelope me-2 text-muted"></i>
                                <a href="mailto:@Teacher.Email" class="text-decoration-none">@Teacher.Email</a>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(Teacher.PhoneNumber))
                            {
                                <div class="mb-2">
                                    <i class="bi bi-telephone me-2 text-muted"></i>
                                    <a href="tel:@Teacher.PhoneNumber" class="text-decoration-none">@Teacher.PhoneNumber</a>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(Teacher.Branch))
                            {
                                <div class="mb-2">
                                    <i class="bi bi-book me-2 text-muted"></i>
                                    <span>@Teacher.Branch</span>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(Teacher.Expertise))
                            {
                                <div class="mb-2">
                                    <i class="bi bi-award me-2 text-muted"></i>
                                    <span>@Teacher.Expertise</span>
                                </div>
                            }
                            
                            @if (Teacher.HireDate.HasValue)
                            {
                                <div class="mb-2">
                                    <i class="bi bi-calendar-check me-2 text-muted"></i>
                                    <span>İşe Başlama: @Teacher.HireDate.Value.ToShortDateString()</span>
                                </div>
                            }
                        </div>
                        
                        <div class="mt-4 d-grid gap-2">
                            <AuthorizeView Roles="Admin">
                                <button class="btn btn-primary" @onclick="() => Navigation.NavigateTo($"/ogretmen/duzenle/{Teacher.Id}")">
                                    <i class="bi bi-pencil-square me-2"></i>Düzenle
                                </button>
                            </AuthorizeView>
                            
                            <button class="btn btn-outline-secondary" @onclick="() => Navigation.NavigateTo("/ogretmenler")">
                                <i class="bi bi-arrow-left me-2"></i>Listeye Dön
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">İstatistikler</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Toplam Ders</span>
                            <span class="fw-bold">@(Courses?.Count() ?? 0)</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Aktif Dersler</span>
                            <span class="fw-bold">@(Courses?.Count(c => c.IsActive) ?? 0)</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Toplam Öğrenci</span>
                            <span class="fw-bold">@(Courses?.Sum(c => c.StudentCourses?.Count ?? 0) ?? 0)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Verdiği Dersler</h5>
                        <AuthorizeView Roles="Admin">
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => Navigation.NavigateTo("/ders/ekle")">
                                <i class="bi bi-plus-lg me-1"></i>Yeni Ders Ekle
                            </button>
                        </AuthorizeView>
                    </div>
                    
                    @if (IsLoadingCourses)
                    {
                        <div class="card-body text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                        </div>
                    }
                    else if (Courses == null || !Courses.Any())
                    {
                        <div class="card-body text-center p-5 text-muted">
                            <i class="bi bi-book display-5 d-block mb-3"></i>
                            <h5>Henüz ders bulunmuyor</h5>
                            <p class="mb-0">Bu öğretmenin henüz atanmış bir dersi yok.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ders Kodu</th>
                                        <th>Ders Adı</th>
                                        <th>Dönem</th>
                                        <th>Öğrenci Sayısı</th>
                                        <th>Durum</th>
                                        <th class="text-end">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var course in Courses)
                                    {
                                        <tr>
                                            <td>@course.Code</td>
                                            <td>@course.Name</td>
                                            <td>@course.Semester</td>
                                            <td>@(course.StudentCourses?.Count ?? 0)</td>
                                            <td>
                                                <span class="badge @(course.IsActive ? "bg-success" : "bg-secondary")">
                                                    @(course.IsActive ? "Aktif" : "Pasif")
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" @onclick="() => ViewCourse(course.Id)">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <AuthorizeView Roles="Admin">
                                                        <button class="btn btn-outline-secondary" @onclick="() => EditCourse(course.Id)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                    </AuthorizeView>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
                
                <!-- Add more sections here for attendance, grades, etc. -->
                
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int TeacherId { get; set; }
    
    private Teacher? Teacher { get; set; }
    private IEnumerable<Course>? Courses { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool IsLoadingCourses { get; set; } = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadTeacherAsync();
        await LoadTeacherCoursesAsync();
    }
    
    private async Task LoadTeacherAsync()
    {
        try
        {
            IsLoading = true;
            Teacher = await TeacherService.GetTeacherByIdAsync(TeacherId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error loading teacher with ID {TeacherId}");
        }
        finally
        {
            IsLoading = false;
        }
    }
    
    private async Task LoadTeacherCoursesAsync()
    {
        try
        {
            IsLoadingCourses = true;
            if (TeacherId > 0)
            {
                Courses = await TeacherService.GetTeacherCoursesAsync(TeacherId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error loading courses for teacher with ID {TeacherId}");
            Courses = new List<Course>();
        }
        finally
        {
            IsLoadingCourses = false;
        }
    }
    
    private void ViewCourse(int courseId)
    {
        Navigation.NavigateTo($"/ders/{courseId}");
    }
    
    private void EditCourse(int courseId)
    {
        Navigation.NavigateTo($"/ders/duzenle/{courseId}");
    }
}
