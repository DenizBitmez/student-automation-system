@using System.Linq.Expressions
@typeparam TItem

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <!-- Search Input -->
            <div class="col-md-4">
                <label class="form-label">Arama</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" 
                           class="form-control" 
                           placeholder="@SearchPlaceholder"
                           @bind="searchTerm" 
                           @bind:after="OnSearchChanged" />
                </div>
            </div>

            <!-- Filter Dropdown -->
            @if (FilterOptions?.Any() == true)
            {
                <div class="col-md-3">
                    <label class="form-label">@FilterLabel</label>
                    <select class="form-select" @bind="selectedFilter" @bind:after="OnFilterChanged">
                        <option value="">Tümü</option>
                        @foreach (var option in FilterOptions)
                        {
                            <option value="@option">@option</option>
                        }
                    </select>
                </div>
            }

            <!-- Sort Dropdown -->
            @if (SortOptions?.Any() == true)
            {
                <div class="col-md-3">
                    <label class="form-label">Sıralama</label>
                    <select class="form-select" @bind="selectedSort" @bind:after="OnSortChanged">
                        @foreach (var option in SortOptions)
                        {
                            <option value="@option.Key">@option.Value</option>
                        }
                    </select>
                </div>
            }

            <!-- Results Count -->
            <div class="col-md-2 d-flex align-items-end">
                <div class="text-muted small">
                    @FilteredItems.Count() / @TotalCount sonuç
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<TItem> Items { get; set; } = Enumerable.Empty<TItem>();
    [Parameter] public EventCallback<IEnumerable<TItem>> ItemsChanged { get; set; }
    [Parameter] public Func<TItem, string> SearchFunction { get; set; } = _ => string.Empty;
    [Parameter] public string SearchPlaceholder { get; set; } = "Ara...";
    [Parameter] public IEnumerable<string>? FilterOptions { get; set; }
    [Parameter] public Func<TItem, string, bool>? FilterFunction { get; set; }
    [Parameter] public string FilterLabel { get; set; } = "Filtre";
    [Parameter] public Dictionary<string, string>? SortOptions { get; set; }
    [Parameter] public Dictionary<string, Func<TItem, object>>? SortFunctions { get; set; }
    [Parameter] public int TotalCount { get; set; }

    private string searchTerm = string.Empty;
    private string selectedFilter = string.Empty;
    private string selectedSort = string.Empty;
    private IEnumerable<TItem> FilteredItems { get; set; } = Enumerable.Empty<TItem>();

    protected override void OnInitialized()
    {
        FilteredItems = Items;
    }

    protected override void OnParametersSet()
    {
        ApplyFilters();
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void OnFilterChanged()
    {
        ApplyFilters();
    }

    private void OnSortChanged()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filtered = Items.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(item => 
                SearchFunction(item).Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Apply category filter
        if (!string.IsNullOrWhiteSpace(selectedFilter) && FilterFunction != null)
        {
            filtered = filtered.Where(item => FilterFunction(item, selectedFilter));
        }

        // Apply sorting
        if (!string.IsNullOrWhiteSpace(selectedSort) && SortFunctions?.ContainsKey(selectedSort) == true)
        {
            var sortFunction = SortFunctions[selectedSort];
            filtered = filtered.OrderBy(sortFunction);
        }

        FilteredItems = filtered.ToList();
        ItemsChanged.InvokeAsync(FilteredItems);
    }
}