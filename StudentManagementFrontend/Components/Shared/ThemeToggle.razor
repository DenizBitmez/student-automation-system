@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<div class="theme-toggle">
    <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleTheme" title="Tema Değiştir">
        @if (isDarkMode)
        {
            <i class="bi bi-sun"></i>
        }
        else
        {
            <i class="bi bi-moon"></i>
        }
    </button>
</div>

@code {
    private bool isDarkMode = false;

    protected override async Task OnInitializedAsync()
    {
        // Load theme preference from local storage
        var theme = await LocalStorage.GetItemAsync<string>("theme");
        isDarkMode = theme == "dark";
        
        // Apply theme on page load
        await ApplyTheme();
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        
        // Save theme preference
        await LocalStorage.SetItemAsync("theme", isDarkMode ? "dark" : "light");
        
        // Apply theme
        await ApplyTheme();
    }

    private async Task ApplyTheme()
    {
        var theme = isDarkMode ? "dark" : "light";
        
        await JSRuntime.InvokeVoidAsync("setTheme", theme);
        
        StateHasChanged();
    }
}

<script>
    window.setTheme = (theme) => {
        document.documentElement.setAttribute('data-bs-theme', theme);
        
        // Update CSS custom properties for additional theming
        const root = document.documentElement;
        
        if (theme === 'dark') {
            root.style.setProperty('--bs-body-bg', '#1a1a1a');
            root.style.setProperty('--bs-body-color', '#fff');
            root.style.setProperty('--bs-card-bg', '#2d2d2d');
            root.style.setProperty('--bs-border-color', '#404040');
        } else {
            root.style.setProperty('--bs-body-bg', '#ffffff');
            root.style.setProperty('--bs-body-color', '#000');
            root.style.setProperty('--bs-card-bg', '#ffffff');
            root.style.setProperty('--bs-border-color', '#dee2e6');
        }
    };

    // Auto-detect system theme on initial load
    window.detectSystemTheme = () => {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }
        return 'light';
    };

    // Listen for system theme changes
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            // Only auto-switch if user hasn't set a preference
            const userTheme = localStorage.getItem('theme');
            if (!userTheme) {
                window.setTheme(e.matches ? 'dark' : 'light');
            }
        });
    }
</script>

<style>
    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }

    .theme-toggle button {
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .theme-toggle button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Dark theme styles */
    [data-bs-theme="dark"] {
        --bs-body-bg: #1a1a1a;
        --bs-body-color: #fff;
        --bs-card-bg: #2d2d2d;
        --bs-border-color: #404040;
    }

    [data-bs-theme="dark"] .card {
        background-color: var(--bs-card-bg);
        border-color: var(--bs-border-color);
    }

    [data-bs-theme="dark"] .table {
        --bs-table-bg: #2d2d2d;
        --bs-table-border-color: #404040;
    }

    [data-bs-theme="dark"] .navbar {
        background-color: #1a1a1a !important;
    }

    [data-bs-theme="dark"] .nav-link {
        color: rgba(255, 255, 255, 0.75);
    }

    [data-bs-theme="dark"] .nav-link:hover {
        color: white;
    }

    /* Smooth transitions */
    * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
</style>