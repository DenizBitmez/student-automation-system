@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<div class="theme-customizer @(isOpen ? "open" : "")">
    <div class="customizer-toggle" @onclick="ToggleCustomizer">
        <i class="bi bi-palette"></i>
    </div>

    <div class="customizer-content">
        <div class="customizer-header">
            <h6 class="mb-0">
                <i class="bi bi-palette me-2"></i>
                Tema Özelleştirme
            </h6>
            <button type="button" class="btn-close" @onclick="ToggleCustomizer"></button>
        </div>

        <div class="customizer-body">
            <!-- Theme Mode -->
            <div class="customizer-section">
                <h6>Tema Modu</h6>
                <div class="theme-options">
                    <div class="theme-option @(currentTheme == "light" ? "active" : "")" 
                         @onclick="() => SetTheme(\"light\")">
                        <div class="theme-preview light-preview">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <span class="theme-name">Açık Tema</span>
                    </div>

                    <div class="theme-option @(currentTheme == "dark" ? "active" : "")" 
                         @onclick="() => SetTheme(\"dark\")">
                        <div class="theme-preview dark-preview">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <span class="theme-name">Koyu Tema</span>
                    </div>

                    <div class="theme-option @(currentTheme == "auto" ? "active" : "")" 
                         @onclick="() => SetTheme(\"auto\")">
                        <div class="theme-preview auto-preview">
                            <div class="preview-header gradient-bg"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <span class="theme-name">Otomatik</span>
                    </div>
                </div>
            </div>

            <!-- Primary Color -->
            <div class="customizer-section">
                <h6>Ana Renk</h6>
                <div class="color-options">
                    @foreach (var color in primaryColors)
                    {
                        <div class="color-option @(currentPrimaryColor == color.Value ? "active" : "")"
                             style="background-color: @color.Value"
                             @onclick="() => SetPrimaryColor(color.Value)"
                             title="@color.Name">
                        </div>
                    }
                </div>
                <div class="mt-2">
                    <label class="form-label small">Özel Renk</label>
                    <input type="color" class="form-control form-control-color" 
                           @bind="customPrimaryColor" @onchange="OnCustomColorChange" />
                </div>
            </div>

            <!-- Sidebar Style -->
            <div class="customizer-section">
                <h6>Kenar Çubuğu</h6>
                <div class="sidebar-options">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sidebarStyle" 
                               id="sidebarLight" checked="@(currentSidebarStyle == "light")"
                               @onchange="() => SetSidebarStyle(\"light\")" />
                        <label class="form-check-label" for="sidebarLight">
                            Açık
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sidebarStyle" 
                               id="sidebarDark" checked="@(currentSidebarStyle == "dark")"
                               @onchange="() => SetSidebarStyle(\"dark\")" />
                        <label class="form-check-label" for="sidebarDark">
                            Koyu
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sidebarStyle" 
                               id="sidebarColored" checked="@(currentSidebarStyle == "colored")"
                               @onchange="() => SetSidebarStyle(\"colored\")" />
                        <label class="form-check-label" for="sidebarColored">
                            Renkli
                        </label>
                    </div>
                </div>
            </div>

            <!-- Font Size -->
            <div class="customizer-section">
                <h6>Yazı Boyutu</h6>
                <div class="font-size-options">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fontSize" 
                               id="fontSmall" checked="@(currentFontSize == "small")"
                               @onchange="() => SetFontSize(\"small\")" />
                        <label class="form-check-label" for="fontSmall">
                            Küçük
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fontSize" 
                               id="fontMedium" checked="@(currentFontSize == "medium")"
                               @onchange="() => SetFontSize(\"medium\")" />
                        <label class="form-check-label" for="fontMedium">
                            Orta
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fontSize" 
                               id="fontLarge" checked="@(currentFontSize == "large")"
                               @onchange="() => SetFontSize(\"large\")" />
                        <label class="form-check-label" for="fontLarge">
                            Büyük
                        </label>
                    </div>
                </div>
            </div>

            <!-- Layout Options -->
            <div class="customizer-section">
                <h6>Düzen Seçenekleri</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="compactMode" 
                           checked="@compactMode" @onchange="ToggleCompactMode" />
                    <label class="form-check-label" for="compactMode">
                        Kompakt Mod
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="animations" 
                           checked="@animationsEnabled" @onchange="ToggleAnimations" />
                    <label class="form-check-label" for="animations">
                        Animasyonlar
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="rtl" 
                           checked="@rtlMode" @onchange="ToggleRtl" />
                    <label class="form-check-label" for="rtl">
                        Sağdan Sola
                    </label>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="customizer-section">
                <button class="btn btn-outline-secondary btn-sm w-100" @onclick="ResetToDefaults">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                    Varsayılana Sıfırla
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isOpen = false;
    private string currentTheme = "light";
    private string currentPrimaryColor = "#0d6efd";
    private string currentSidebarStyle = "light";
    private string currentFontSize = "medium";
    private string customPrimaryColor = "#0d6efd";
    private bool compactMode = false;
    private bool animationsEnabled = true;
    private bool rtlMode = false;

    private readonly List<ColorOption> primaryColors = new()
    {
        new("Mavi", "#0d6efd"),
        new("İndigo", "#6610f2"),
        new("Mor", "#6f42c1"),
        new("Pembe", "#d63384"),
        new("Kırmızı", "#dc3545"),
        new("Turuncu", "#fd7e14"),
        new("Sarı", "#ffc107"),
        new("Yeşil", "#198754"),
        new("Teal", "#20c997"),
        new("Cyan", "#0dcaf0"),
        new("Gri", "#6c757d"),
        new("Koyu", "#212529")
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await ApplyAllSettings();
    }

    private async Task LoadSettings()
    {
        currentTheme = await LocalStorage.GetItemAsync<string>("theme") ?? "light";
        currentPrimaryColor = await LocalStorage.GetItemAsync<string>("primaryColor") ?? "#0d6efd";
        currentSidebarStyle = await LocalStorage.GetItemAsync<string>("sidebarStyle") ?? "light";
        currentFontSize = await LocalStorage.GetItemAsync<string>("fontSize") ?? "medium";
        compactMode = await LocalStorage.GetItemAsync<bool>("compactMode");
        animationsEnabled = await LocalStorage.GetItemAsync<bool>("animationsEnabled") ? true : true;
        rtlMode = await LocalStorage.GetItemAsync<bool>("rtlMode");
        customPrimaryColor = currentPrimaryColor;
    }

    private void ToggleCustomizer()
    {
        isOpen = !isOpen;
    }

    private async Task SetTheme(string theme)
    {
        currentTheme = theme;
        await LocalStorage.SetItemAsync("theme", theme);
        await JSRuntime.InvokeVoidAsync("applyTheme", theme);
    }

    private async Task SetPrimaryColor(string color)
    {
        currentPrimaryColor = color;
        customPrimaryColor = color;
        await LocalStorage.SetItemAsync("primaryColor", color);
        await JSRuntime.InvokeVoidAsync("applyPrimaryColor", color);
    }

    private async Task OnCustomColorChange()
    {
        await SetPrimaryColor(customPrimaryColor);
    }

    private async Task SetSidebarStyle(string style)
    {
        currentSidebarStyle = style;
        await LocalStorage.SetItemAsync("sidebarStyle", style);
        await JSRuntime.InvokeVoidAsync("applySidebarStyle", style);
    }

    private async Task SetFontSize(string size)
    {
        currentFontSize = size;
        await LocalStorage.SetItemAsync("fontSize", size);
        await JSRuntime.InvokeVoidAsync("applyFontSize", size);
    }

    private async Task ToggleCompactMode()
    {
        compactMode = !compactMode;
        await LocalStorage.SetItemAsync("compactMode", compactMode);
        await JSRuntime.InvokeVoidAsync("applyCompactMode", compactMode);
    }

    private async Task ToggleAnimations()
    {
        animationsEnabled = !animationsEnabled;
        await LocalStorage.SetItemAsync("animationsEnabled", animationsEnabled);
        await JSRuntime.InvokeVoidAsync("applyAnimations", animationsEnabled);
    }

    private async Task ToggleRtl()
    {
        rtlMode = !rtlMode;
        await LocalStorage.SetItemAsync("rtlMode", rtlMode);
        await JSRuntime.InvokeVoidAsync("applyRtl", rtlMode);
    }

    private async Task ResetToDefaults()
    {
        currentTheme = "light";
        currentPrimaryColor = "#0d6efd";
        currentSidebarStyle = "light";
        currentFontSize = "medium";
        compactMode = false;
        animationsEnabled = true;
        rtlMode = false;
        customPrimaryColor = "#0d6efd";

        await LocalStorage.ClearAsync();
        await ApplyAllSettings();
        StateHasChanged();
    }

    private async Task ApplyAllSettings()
    {
        await JSRuntime.InvokeVoidAsync("applyTheme", currentTheme);
        await JSRuntime.InvokeVoidAsync("applyPrimaryColor", currentPrimaryColor);
        await JSRuntime.InvokeVoidAsync("applySidebarStyle", currentSidebarStyle);
        await JSRuntime.InvokeVoidAsync("applyFontSize", currentFontSize);
        await JSRuntime.InvokeVoidAsync("applyCompactMode", compactMode);
        await JSRuntime.InvokeVoidAsync("applyAnimations", animationsEnabled);
        await JSRuntime.InvokeVoidAsync("applyRtl", rtlMode);
    }

    private class ColorOption
    {
        public string Name { get; set; }
        public string Value { get; set; }

        public ColorOption(string name, string value)
        {
            Name = name;
            Value = value;
        }
    }
}

<style>
    .theme-customizer {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 1060;
        transition: all 0.3s ease;
    }

    .theme-customizer.open {
        right: 0;
    }

    .customizer-toggle {
        position: absolute;
        left: -45px;
        top: 50%;
        transform: translateY(-50%);
        width: 45px;
        height: 45px;
        background: var(--bs-primary);
        color: white;
        border-radius: 8px 0 0 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .customizer-toggle:hover {
        background: var(--bs-primary);
        transform: translateY(-50%) scale(1.1);
    }

    .customizer-content {
        width: 300px;
        height: 80vh;
        max-height: 600px;
        background: white;
        border-radius: 8px 0 0 8px;
        box-shadow: -4px 0 20px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .theme-customizer.open .customizer-content {
        transform: translateX(0);
    }

    .customizer-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .customizer-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .customizer-section {
        margin-bottom: 1.5rem;
    }

    .customizer-section h6 {
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #495057;
    }

    .theme-options {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .theme-option {
        flex: 1;
        text-align: center;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 0.5rem;
        transition: all 0.3s ease;
    }

    .theme-option.active {
        border-color: var(--bs-primary);
    }

    .theme-option:hover {
        border-color: var(--bs-primary);
        opacity: 0.8;
    }

    .theme-preview {
        width: 50px;
        height: 35px;
        border-radius: 4px;
        margin: 0 auto 0.25rem;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }

    .light-preview {
        background: #fff;
    }

    .light-preview .preview-header {
        height: 8px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .light-preview .preview-sidebar {
        position: absolute;
        left: 0;
        top: 8px;
        width: 15px;
        bottom: 0;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
    }

    .light-preview .preview-content {
        position: absolute;
        left: 15px;
        top: 8px;
        right: 0;
        bottom: 0;
        background: #fff;
    }

    .dark-preview {
        background: #212529;
    }

    .dark-preview .preview-header {
        height: 8px;
        background: #343a40;
    }

    .dark-preview .preview-sidebar {
        position: absolute;
        left: 0;
        top: 8px;
        width: 15px;
        bottom: 0;
        background: #2d3439;
    }

    .dark-preview .preview-content {
        position: absolute;
        left: 15px;
        top: 8px;
        right: 0;
        bottom: 0;
        background: #212529;
    }

    .auto-preview {
        background: linear-gradient(45deg, #fff 50%, #212529 50%);
    }

    .auto-preview .preview-header {
        height: 8px;
        background: linear-gradient(90deg, #f8f9fa 50%, #343a40 50%);
    }

    .auto-preview .preview-sidebar {
        position: absolute;
        left: 0;
        top: 8px;
        width: 15px;
        bottom: 0;
        background: linear-gradient(180deg, #f8f9fa 50%, #2d3439 50%);
    }

    .auto-preview .preview-content {
        position: absolute;
        left: 15px;
        top: 8px;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #fff 50%, #212529 50%);
    }

    .theme-name {
        font-size: 0.75rem;
        font-weight: 500;
    }

    .color-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
    }

    .color-option.active {
        border-color: #fff;
        box-shadow: 0 0 0 2px var(--bs-primary);
    }

    .color-option::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .color-option.active::after {
        opacity: 1;
    }

    .sidebar-options,
    .font-size-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .gradient-bg {
        background: linear-gradient(45deg, #007bff, #6610f2) !important;
    }

    [data-bs-theme="dark"] .customizer-content {
        background: #2d3439;
        color: white;
    }

    [data-bs-theme="dark"] .customizer-header {
        border-color: #404040;
    }

    [data-bs-theme="dark"] .theme-preview {
        border-color: #404040;
    }

    @media (max-width: 768px) {
        .customizer-content {
            width: 280px;
        }
        
        .theme-customizer {
            right: -280px;
        }
        
        .theme-customizer.open {
            right: 0;
        }
    }
</style>

<script>
    window.applyTheme = (theme) => {
        if (theme === 'auto') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            theme = prefersDark ? 'dark' : 'light';
        }
        document.documentElement.setAttribute('data-bs-theme', theme);
    };

    window.applyPrimaryColor = (color) => {
        document.documentElement.style.setProperty('--bs-primary', color);
        document.documentElement.style.setProperty('--bs-primary-rgb', hexToRgb(color));
    };

    window.applySidebarStyle = (style) => {
        document.body.setAttribute('data-sidebar', style);
    };

    window.applyFontSize = (size) => {
        const sizes = { small: '14px', medium: '16px', large: '18px' };
        document.documentElement.style.setProperty('--bs-body-font-size', sizes[size]);
    };

    window.applyCompactMode = (enabled) => {
        document.body.classList.toggle('compact-mode', enabled);
    };

    window.applyAnimations = (enabled) => {
        document.body.classList.toggle('no-animations', !enabled);
    };

    window.applyRtl = (enabled) => {
        document.documentElement.setAttribute('dir', enabled ? 'rtl' : 'ltr');
        document.body.classList.toggle('rtl', enabled);
    };

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
    }
</script>