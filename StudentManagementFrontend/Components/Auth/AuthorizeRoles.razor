@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Logging
@inject IAuthService AuthService
@inject ILogger<AuthorizeRoles> Logger

<AuthorizeView Roles="@string.Join(',', Roles ?? Array.Empty<string>())">
    <Authorized>
        @ChildContent
    </Authorized>
    <NotAuthorized>
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="alert alert-danger">
                <h4>Erişim Reddedildi</h4>
                <p>Bu sayfayı görüntülemek için gerekli yetkiniz bulunmamaktadır.</p>
                <a href="/" class="btn btn-primary">Anasayfaya Dön</a>
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                <h4>Giriş Gerekli</h4>
                <p>Bu sayfayı görüntülemek için lütfen giriş yapın.</p>
                <a href="/giris?returnUrl=@NavigationManager.Uri" class="btn btn-primary">Giriş Yap</a>
            </div>
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] 
    public RenderFragment ChildContent { get; set; } = default!;
    
    [Parameter]
    public string[]? Roles { get; set; }
    
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    
    [Inject]
    public NavigationManager NavigationManager { get; set; } = default!;
    
    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true && Roles?.Any() == true)
            {
                var hasRequiredRole = await AuthService.IsUserInAnyRoleAsync(Roles);
                if (!hasRequiredRole)
                {
                    Logger.LogWarning("User {Username} attempted to access a restricted resource requiring roles: {Roles}", 
                        user.Identity.Name, string.Join(", ", Roles));
                }
            }
        }
    }
}
